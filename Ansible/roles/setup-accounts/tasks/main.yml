---
- name: create groups
  group: name=g{{ item }} state=present
  with_sequence:
    - count=6

- name: add users for m0
  user: name={{ item.name }} state=present groups={{ item.groups }} uid={{ item.uid }}
  when: hostname == 'm0'
  with_items:
  - "{{ m0_accounts }}"

- name: add users for m1
  user: name={{ item.name }} state=present groups={{ item.groups }} uid={{ item.uid }}
  when: hostname == 'm1'
  with_items:
  - "{{ m1_accounts }}"

- name: add users for m2
  user: name={{ item.name }} state=present groups={{ item.groups }} uid={{ item.uid }}
  when: hostname == 'm2'
  with_items:
  - "{{ m2_accounts }}"

- name: Get list of home directories
  command: ls /home
  register: home_dirs

- name: Create user files
  lineinfile: dest=/home/{{ item }}/myfile state=present regexp='^.*$' line={{ item }} create=true owner={{ item }} group={{ item }} mode=0644
  with_items:
  - "{{ home_dirs.stdout_lines }}"

- name: Account Unit Tests
  include: unit_tests.yml
  tags: unit_tests

