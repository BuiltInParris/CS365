---
  - name: Install hosts file
    # From: http://xmeblog.blogspot.com/2013/06/ansible-dynamicaly-update-etchosts.html
    lineinfile: dest=/etc/hosts regexp='.*{{ item }}$' line="{{ hostvars[item]['ansible_default_ipv4']['address'] }} {{item}}" state=present
    when: hostvars[item]['ansible_default_ipv4']['address'] is defined
    with_items: groups['all'] 

  - name: Set Hostname
    shell: hostname {{ hostname }}

  - name: Set /etc/hostname
    lineinfile: dest=/etc/hostname state=present regexp='^.*$' line={{ hostname }}